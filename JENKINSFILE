pipeline {
    agent {label 'jenkins'}
    
    options { skipDefaultCheckout() }
    
    environment {
        DEPLOY_ENV = 'staging'   // default | staging | production
    }
    
    stages {
        stage('Get Code') {
            steps {
                git branch:'develop', url:'https://github.com/Soratadev/todo-list-aws'
                stash name:'code', includes:'**'
            }
        }
        stage('Static Test') {
            steps {
                unstash name:'code'
                sh '''
                    python3 -m flake8 --exit-zero --format=pylint src >flake8.out
                    python3 -m bandit -r src -f custom -o bandit.out --msg-template "{abspath}:{line}: [{test_id}] {msg}" || true
                '''
                recordIssues tools: [flake8(name: 'Flake8', pattern: 'flake8.out')], qualityGates: [[threshold: 10, type: 'TOTAL', unstable: true], [threshold: 11, type: 'TOTAL', unstable: false]]
                recordIssues tools: [pyLint(name: 'Bandit', pattern: 'bandit.out')], qualityGates: [[threshold: 1, type: 'TOTAL', unstable: true], [threshold: 2, type: 'TOTAL', unstable: false]]
            }
        }
        stage ('Build') {
            steps {
                sh '''
                    bash -euxo pipefail <<'E0F'
                    sam build \
                        --template-file template.yaml
                '''
            }
        }
        stage('Validate') {
            steps {
                sh '''
                    bash -euxo pipefail <<'E0F'

                    echo "Validating SAM template..."

                    sam validate \
                      --config-file samconfig.toml \
                      --config-env ${DEPLOY_ENV} \
                      --region 'us-east-1'
                '''
            }
        }
        stage('Deploy') {
            steps {
                sh '''
                    bash -euxo pipefail <<'E0F'

                    echo "Deploying SAM stack..."

                    sam deploy \
                      --config-file samconfig.toml \
                      --config-env ${DEPLOY_ENV} \
                      --resolve-s3 \
                      --no-confirm-changeset
                '''
            }
        }
        stage('Rest Test') {
            steps {
                script {
                    env.BASE_URL = sh(
                        script: '''
                            aws cloudformation describe-stacks \
                            --stack-name staging-todo-list-aws \
                            --query 'Stacks[0].Outputs[?OutputKey==`BaseUrlApi`].OutputValue' \
                            --region us-east-1 \
                            --output text
                        ''', returnStdout: true
                    ).trim()
                }
                echo "Base URL: ${env.BASE_URL}"
                sh '''
                    bash -euxo pipefail <<'EOF'
                    echo "Running tests against $BASE_URL"

                    pytest --junitxml=result-rest.xml test/integration/todoApiTest.py
                '''
                junit 'result-rest.xml'
            }
        }
       stage('Promote') {
            steps {
                script {
                    withCredentials([string(credentialsId: 'github-token', variable: 'GITHUB_TOKEN')]) {
                        sh '''
                            bash -euxo pipefail
        
                            rm -rf repo
        
                            git clone https://Soratadev:${GITHUB_TOKEN}@github.com/Soratadev/todo-list-aws.git repo
                            cd repo
        
                            git config user.name "Soratadev"
                            git config user.email "sorata.arctica@gmail.com"
        
                            # Traer todas las ramas
                            git fetch origin
        
                            # Sincronizar develop limpio
                            git checkout develop
                            git reset --hard origin/develop
        
                            # Sincronizar master limpio
                            git checkout master
                            git reset --hard origin/master
        
                            # Merge controlado
                            git config merge.ours.driver true
                            
                            if git merge --no-ff origin/develop -m "Merge develop into master [Automated by Jenkins]"; then
                                git push origin master
                            else
                                echo "Merge conflict detected. Aborting."
                                git merge --abort
                                exit 1
                            fi
                        '''
                    }
                }
            }
        }
    }
}