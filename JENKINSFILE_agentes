pipeline {
    agent any
    options { skipDefaultCheckout() }
    
    environment {
        DEPLOY_ENV = 'staging'   // default | staging | production
    }
    
    stages {
        stage('Get Code') {
            agent {label 'jenkins'}
            steps {
                git branch:'develop', url:'https://github.com/Soratadev/todo-list-aws'
                stash name:'code', includes:'**'
                cleanWs()
            }
        }
        stage('Static Test') {
            agent {label 'jenkins'}
            steps {
                unstash name:'code'
                sh '''
                    python3 -m flake8 --exit-zero --format=pylint src >flake8.out
                    python3 -m bandit -r src -f custom -o bandit.out --msg-template "{abspath}:{line}: [{test_id}] {msg}" || true
                '''
                recordIssues tools: [flake8(name: 'Flake8', pattern: 'flake8.out')], qualityGates: [[threshold: 10, type: 'TOTAL', unstable: true], [threshold: 11, type: 'TOTAL', unstable: false]]
                recordIssues tools: [pyLint(name: 'Bandit', pattern: 'bandit.out')], qualityGates: [[threshold: 1, type: 'TOTAL', unstable: true], [threshold: 2, type: 'TOTAL', unstable: false]]
                cleanWs()
            }
        }
        stage ('Build') {
            agent {label 'jenkins'}
            steps {
                unstash name:'code'
                sh '''
                    bash -euxo pipefail <<'E0F'
                    sam build \
                        --template-file template.yaml
                '''
                stash name:'deploy', includes:'**'
                cleanWs()
            }
        }
        stage('Validate') {
            agent {label 'ubuntu'}
            steps {
                unstash name:'deploy'
                sh '''
                    bash -euxo pipefail <<'E0F'

                    echo "Validating SAM template..."

                    sam validate \
                      --config-file samconfig.toml \
                      --config-env ${DEPLOY_ENV} \
                      --region 'us-east-1'
                '''
                stash name:'deploy', includes:'**'
                cleanWs()
            }
        }
        stage('Deploy') {
            agent {label 'jenkins'}
            steps {
                unstash name:'deploy'
                sh '''
                    bash -euxo pipefail <<'E0F'

                    echo "Deploying SAM stack..."

                    sam deploy \
                      --config-file samconfig.toml \
                      --config-env ${DEPLOY_ENV} \
                      --resolve-s3 \
                      --no-confirm-changeset
                '''
                script {
                    env.BASE_URL = sh(
                        script: '''
                            aws cloudformation describe-stacks \
                            --stack-name staging-todo-list-aws \
                            --query 'Stacks[0].Outputs[?OutputKey==`BaseUrlApi`].OutputValue' \
                            --region us-east-1 \
                            --output text
                        ''', returnStdout: true
                    ).trim()
                }
                stash name:'deploy', includes: '**'
                cleanWs()
            }
        }
        stage('Rest Test') {
            agent {label 'ubuntu'}
            steps {
                unstash name:'deploy'
                echo "Base URL: ${env.BASE_URL}"
                sh '''
                    bash -euxo pipefail <<'EOF'
                    echo "Running tests against $BASE_URL"

                    pytest test/integration/todoApiTest.py
                '''
                stash name:'deploy', includes:'**'
                cleanWs()
            }
        }
        stage('Promote') {
            agent {label 'jenkins'}
            steps {
                unstash name:'deploy'
                script {
                    withCredentials([string(credentialsId: 'github-token', variable: 'GITHUB_TOKEN')]) {
                        sh '''
                            bash -euxo pipefail
        
                            if [ ! -d repo ]; then
                              git clone -b develop https://Soratadev:$GITHUB_TOKEN@github.com/Soratadev/todo-list-aws.git repo
                            fi
        
                            cd repo
        
                            git config user.name "Soratadev"
                            git config user.email "sorata.arctica@gmail.com"
        
                            git remote set-url origin https://Soratadev:$GITHUB_TOKEN@github.com/Soratadev/todo-list-aws.git
        
                            git checkout develop
                            git pull origin develop
        
                            git checkout master
                            git pull origin master
                            
                            git merge --no-ff --no-commit develop || true
                            
                            git checkout --ours JENKINSFILE || true
                            git checkout --ours .gitattributes || true
                            
                            git add JENKINSFILE || true
                            git add .gitattributes || true
                            
                            git add -A
                            
                            git commit -m "Merge develop into master [Automated by Jenkins]"
                            
                            git push origin master
                        '''
                    }
                }
            }
        }
    }
}
